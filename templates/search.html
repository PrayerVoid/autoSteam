<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if lang == 'zh' %}æ¸¸æˆæœç´¢{% else %}Game Search{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="{{ url_for('home', lang=lang) }}">{% if lang == 'zh' %}Steamæ¸¸æˆæœç´¢{% else %}Steam Game Search{% endif %}</a>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('home', lang=lang) }}">{% if lang == 'zh' %}é¦–é¡µ{% else %}Home{% endif %}</a>
            <a href="{{ url_for('category', lang=lang) }}">{% if lang == 'zh' %}æ¸¸æˆåˆ†ç±»{% else %}Categories{% endif %}</a>
            <a href="{{ url_for('guide', lang=lang) }}">{% if lang == 'zh' %}è¯´æ˜æŒ‡å—{% else %}Guide{% endif %}</a>
            <a href="{{ url_for('ai_recommend', lang=lang) }}">{% if lang == 'zh' %}AIæ¨è{% else %}AI Recommend{% endif %}</a>
        </div>
        <div class="language-switch">
            <a href="{{ request.path }}{% if request.query_string %}?{{ request.query_string.decode('utf-8').replace('lang=' + lang, 'lang=zh') }}{% else %}?lang=zh{% endif %}">ä¸­æ–‡</a> | 
            <a href="{{ request.path }}{% if request.query_string %}?{{ request.query_string.decode('utf-8').replace('lang=' + lang, 'lang=en') }}{% else %}?lang=en{% endif %}">English</a>
        </div>
    </nav>

    <main class="search-results-page">
        <!-- æœç´¢æ¡†ç§»åˆ°ç­›é€‰æ¡†å¤–éƒ¨ -->
        <div class="search-box-container">
            <div class="search-box">
                <input type="text" id="searchInput" 
                       placeholder="{% if lang == 'zh' %}è¾“å…¥æœç´¢è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼š(#åç§°)=æ˜Ÿéœ²è°·ç‰©è¯­(#ä»·æ ¼)<100{% else %}Enter search expression, e.g.: (#Name)=Stardew Valley(#price)<100{% endif %}" 
                       value="{{ query }}">
                <button onclick="performSearch()">{% if lang == 'zh' %}æœç´¢{% else %}Search{% endif %}</button>
                <a href="{{ url_for('advanced_search', lang=lang) }}" class="advanced-search-link">
                    {% if lang == 'zh' %}é«˜çº§æ£€ç´¢{% else %}Advanced Search{% endif %}
                </a>
            </div>
        </div>

        <aside class="search-container">
            <div class="filter-panel">
                <!-- æ¸¸æˆç±»å‹ç­›é€‰ -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>{% if lang == 'zh' %}æ¸¸æˆç±»å‹{% else %}Game Types{% endif %}</span>
                        <button onclick="resetTypeFilter()">{% if lang == 'zh' %}é‡ç½®{% else %}Reset{% endif %}</button>
                    </div>
                    <div class="filter-options" id="gameTypes">
                        <div class="visible-categories"></div>
                        <div class="more-categories" style="display: none;"></div>
                        <button class="show-more-btn" onclick="toggleMoreCategories()">
                            {% if lang == 'zh' %}æ˜¾ç¤ºæ›´å¤š{% else %}Show More{% endif %}
                        </button>
                    </div>
                </div>

                <!-- æ¸¸æˆæ ‡ç­¾ç­›é€‰ -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>{% if lang == 'zh' %}æ¸¸æˆæ ‡ç­¾{% else %}Game Tags{% endif %}</span>
                        <button onclick="resetTagFilter()">{% if lang == 'zh' %}é‡ç½®{% else %}Reset{% endif %}</button>
                    </div>
                    <div class="filter-options" id="gameTags">
                        <div class="visible-tags"></div>
                        <div class="more-tags" style="display: none;"></div>
                        <button class="show-more-btn" onclick="toggleMoreTags()">
                            {% if lang == 'zh' %}æ˜¾ç¤ºæ›´å¤š{% else %}Show More{% endif %}
                        </button>
                    </div>
                </div>

                <!-- é¢å¤–ç­›é€‰é€‰é¡¹ -->
                <div class="filter-section">
                    <div class="filter-title">
                        <span>{% if lang == 'zh' %}é¢å¤–ç­›é€‰{% else %}Additional Filters{% endif %}</span>
                        <div class="filter-actions">
                            <button onclick="toggleAdditionalFilters()" class="toggle-btn collapsed">
                                <span class="toggle-icon">â–¶</span>
                            </button>
                            <button onclick="resetAdditionalFilters()">{% if lang == 'zh' %}é‡ç½®{% else %}Reset{% endif %}</button>
                        </div>
                    </div>
                    <div class="filter-options collapsed" id="additionalFilters">
                        <!-- å‘å¸ƒå¹´ä»½ç­›é€‰ -->
                        <div class="filter-subsection">
                            <div class="filter-subtitle release-year-title" title="{% if lang == 'zh' %}é€‰æ‹©æŸä¸€å¹´å°†æ˜¾ç¤ºè¯¥å¹´åŠä»¥åçš„æ‰€æœ‰æ¸¸æˆ{% else %}Selecting a year will show all games from that year onwards{% endif %}">
                                {% if lang == 'zh' %}å‘å¸ƒå¹´ä»½{% else %}Release Year{% endif %}
                                <span class="info-icon">â„¹ï¸</span>
                            </div>
                            <div class="date-range">
                                <select id="releaseYearFilter" onchange="performSearch()">
                                    <option value="">{% if lang == 'zh' %}å…¨éƒ¨å¹´ä»½{% else %}All Years{% endif %}</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                    <option value="2017">2017</option>
                                    <option value="2016">2016</option>
                                    <option value="2015">2015</option>
                                    <option value="2014">2014</option>
                                    <option value="2013">2013</option>
                                    <option value="2012">2012</option>
                                    <option value="2011">2011</option>
                                    <option value="2010">2010</option>
                                    <option value="2009">2009</option>
                                    <option value="2008">2008</option>
                                    <option value="2007">2007</option>
                                    <option value="2006">2006</option>
                                    <option value="2005">2005</option>
                                    <option value="2004">2004</option>
                                    <option value="2003">2003</option>
                                    <option value="2002">2002</option>
                                    <option value="2001">2001</option>
                                    <option value="2000">2000</option>
                                    <option value="before_2000">{% if lang == 'zh' %}2000å¹´ä»¥å‰{% else %}Before 2000{% endif %}</option>
                                </select>
                            </div>
                        </div>

                        <!-- æ”¯æŒå¹³å°ç­›é€‰ -->
                        <div class="filter-subsection">
                            <div class="filter-subtitle">
                                {% if lang == 'zh' %}æ”¯æŒå¹³å°{% else %}Platforms{% endif %}
                            </div>
                            <div class="platform-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="platform" value="windows" onchange="performSearch()">
                                    <span>Windows</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="platform" value="mac" onchange="performSearch()">
                                    <span>Mac</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="platform" value="linux" onchange="performSearch()">
                                    <span>Linux</span>
                                </label>
                            </div>
                        </div>

                        <!-- é€‚ç”¨å¹´é¾„ç­›é€‰ -->
                        <div class="filter-subsection">
                            <div class="filter-subtitle">
                                {% if lang == 'zh' %}é€‚ç”¨å¹´é¾„{% else %}Age Rating{% endif %}
                            </div>
                            <div class="age-rating-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="ageRating" value="3" onchange="performSearch()">
                                    <span>3+</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="ageRating" value="7" onchange="performSearch()">
                                    <span>7+</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="ageRating" value="12" onchange="performSearch()">
                                    <span>12+</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="ageRating" value="16" onchange="performSearch()">
                                    <span>16+</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="ageRating" value="18" onchange="performSearch()">
                                    <span>18+</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <div class="search-results">
            <div class="search-header">
                <div class="search-stats">
                    {% if lang == 'zh' %}
                    æ‰¾åˆ° <span id="resultCount">0</span> ä¸ªç»“æœ
                    {% else %}
                    Found <span id="resultCount">0</span> results
                    {% endif %}
                </div>
                <div class="sort-options">
                    <select id="sortBy" onchange="performSearch()">
                        <option value="relevance">{% if lang == 'zh' %}ç›¸å…³åº¦{% else %}Relevance{% endif %}</option>
                        <option value="price_asc">{% if lang == 'zh' %}ä»·æ ¼ä»ä½åˆ°é«˜{% else %}Price: Low to High{% endif %}</option>
                        <option value="price_desc">{% if lang == 'zh' %}ä»·æ ¼ä»é«˜åˆ°ä½{% else %}Price: High to Low{% endif %}</option>
                        <option value="date_asc">{% if lang == 'zh' %}å‘å¸ƒæ—¥æœŸä»æ—©åˆ°æ™š{% else %}Release Date: Old to New{% endif %}</option>
                        <option value="date_desc">{% if lang == 'zh' %}å‘å¸ƒæ—¥æœŸä»æ™šåˆ°æ—©{% else %}Release Date: New to Old{% endif %}</option>
                        <option value="rating">{% if lang == 'zh' %}ç”¨æˆ·è¯„åˆ†{% else %}User Rating{% endif %}</option>
                        <option value="popularity">{% if lang == 'zh' %}çƒ­åº¦{% else %}Popularity{% endif %}</option>
                    </select>
                </div>
            </div>

            <div id="searchResults" class="results-grid">
                <!-- å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
            </div>

            <div id="pagination" class="pagination">
                <!-- å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </main>

    <style>
        /* æ·»åŠ æ¸¸æˆå¡ç‰‡çš„æ ·å¼ */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .game-card {
            background: #1b2838;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            text-decoration: none;
            color: #c7d5e0;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }

        .game-info {
            padding: 15px;
        }

        .game-info h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #ffffff;
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .game-stats {
            font-size: 13px;
            color: #8f98a0;
            margin-bottom: 10px;
        }

        .game-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .category-tag, .genre-tag {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
        }

        .category-tag {
            background: #2a475e;
            color: #66c0f4;
        }

        .genre-tag {
            background: #3d4450;
            color: #c7d5e0;
        }

        .game-platforms {
            display: flex;
            gap: 8px;
            font-size: 16px;
        }
    </style>

    <script>
        const lang = '{{ lang }}';
        const pageSize = 20;
        let currentPage = {{ page }};
        let currentFilters = {{ filters|tojson|safe }};
        let selectedFilters = {{ selected_filters|tojson|safe }};  // æ·»åŠ å·²é€‰æ‹©çš„ç­›é€‰æ¡ä»¶
        let currentSort = '{{ sort }}';
        let currentQuery = '{{ query }}';
        let currentMode = '{{ mode }}';

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®æœç´¢æ¡†çš„å€¼
            document.getElementById('searchInput').value = currentQuery;
            
            // è®¾ç½®æ’åºé€‰é¡¹
            document.getElementById('sortBy').value = currentSort;
            
            // å…ˆè·å–æ‰€æœ‰ç­›é€‰é€‰é¡¹
            updateFilterCounts().then(() => {
                // åœ¨è·å–åˆ°ç­›é€‰é€‰é¡¹åï¼Œå†è®¾ç½®é€‰ä¸­çŠ¶æ€
                if (selectedFilters.types) {
                    console.log("Debug - Setting selected types:", selectedFilters.types);
                    selectedFilters.types.forEach(type => {
                    const checkbox = document.querySelector(`#gameTypes input[value="${type}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log("Debug - Checked type:", type);
                    } else {
                        console.log("Debug - Type checkbox not found:", type);
                    }
                });
            }
            
                if (selectedFilters.tags) {
                    console.log("Debug - Setting selected tags:", selectedFilters.tags);
                    selectedFilters.tags.forEach(tag => {
                        const checkbox = document.querySelector(`#gameTags input[value="${tag}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            console.log("Debug - Checked tag:", tag);
                        } else {
                            console.log("Debug - Tag checkbox not found:", tag);
                        }
                    });
                }
                
                if (selectedFilters.platforms) {
                    selectedFilters.platforms.forEach(platform => {
                    const checkbox = document.querySelector(`input[name="platform"][value="${platform}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
                if (selectedFilters.languages) {
                    selectedFilters.languages.forEach(lang => {
                    const checkbox = document.querySelector(`input[name="language"][value="${lang}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
                // åœ¨æ‰€æœ‰ç­›é€‰é€‰é¡¹è®¾ç½®å®Œæˆåï¼Œå†æ‰§è¡Œæœç´¢
            if (currentQuery || Object.keys(currentFilters).length > 0) {
                performSearch();
            }
            });
        });

        // è·å–æ‰€æœ‰ç­›é€‰æ¡ä»¶
        function getFilters() {
            const filters = {};
            
            // è·å–æ¸¸æˆç±»å‹ç­›é€‰ - ä½¿ç”¨ANDé€»è¾‘
            const selectedTypes = Array.from(document.querySelectorAll('#gameTypes input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            if (selectedTypes.length > 0) {
                filters.types = selectedTypes;
                console.log("Debug - Selected types:", selectedTypes);
            }
            
            // è·å–æ¸¸æˆæ ‡ç­¾ç­›é€‰ - ä½¿ç”¨ANDé€»è¾‘
            const selectedTags = Array.from(document.querySelectorAll('#gameTags input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            if (selectedTags.length > 0) {
                filters.tags = selectedTags;
            }
            
            // è·å–å¹³å°ç­›é€‰ - ä½¿ç”¨ANDé€»è¾‘
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platform"]:checked'))
                .map(cb => cb.value);
            if (selectedPlatforms.length > 0) {
                filters.platforms = selectedPlatforms;
            }
            
            // è·å–è¯­è¨€ç­›é€‰ - ä½¿ç”¨ANDé€»è¾‘
            const selectedLanguages = Array.from(document.querySelectorAll('input[name="language"]:checked'))
                .map(cb => cb.value);
            if (selectedLanguages.length > 0) {
                filters.languages = selectedLanguages;
            }

            // è·å–å‘å¸ƒå¹´ä»½ç­›é€‰
            const releaseYear = document.getElementById('releaseYearFilter').value;
            if (releaseYear) {
                if (releaseYear === 'before_2000') {
                    filters.fromDate = '1900-01-01';
                    filters.toDate = '1999-12-31';
                } else {
                    filters.fromDate = `${releaseYear}-01-01`;
                }
            }
            
            return filters;
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            const filters = getFilters();
            const sort = document.getElementById('sortBy').value;
            
            // å¦‚æœæ˜¯é«˜çº§æ£€ç´¢æ¨¡å¼ï¼Œè½¬æ¢å­—æ®µå
            if (currentMode === 'advanced' && query.includes('(#')) {
                // å­—æ®µæ˜ å°„
                const fieldMapping = {
                    'åç§°': 'Name',
                    'æ¸¸æˆç®€ä»‹': 'About the game',
                    'å¼€å‘å•†': 'Developers',
                    'å‘è¡Œå•†': 'Publishers',
                    'åª’ä½“è¯„ä»·': 'Reviews',
                    'ä»·æ ¼': 'price',
                    'å¥½è¯„ç‡': 'rating',
                    'è¯„è®ºæ€»æ•°': 'reviews_count',
                    'æœ€é«˜åŒæ—¶åœ¨çº¿äººæ•°': 'peak_ccu',
                    'å‘å¸ƒæ—¥æœŸ': 'release_date'
                };

                let processedQuery = query;
                if (lang === 'en') {
                    // å¦‚æœæ˜¯è‹±æ–‡æ¨¡å¼ï¼Œå°†ä¸­æ–‡å­—æ®µåæ›¿æ¢ä¸ºè‹±æ–‡
                    Object.entries(fieldMapping).forEach(([zhField, enField]) => {
                        const regex = new RegExp(`\\(#${zhField}\\)`, 'g');
                        processedQuery = processedQuery.replace(regex, `(#${enField})`);
                    });
                }
                
                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: processedQuery,
                            filters: filters,
                            sort: sort,
                            page: currentPage,
                            page_size: pageSize,
                            mode: currentMode,
                            lang: lang
                        })
                    });

                    if (!response.ok) throw new Error('Search failed');

                    const data = await response.json();
                    if (data.status === 'success') {
                        displaySearchResults(data.data);
                        updatePagination(data.total);
                        document.getElementById('resultCount').textContent = data.total;
                        
                        // æ›´æ–°ç­›é€‰é€‰é¡¹çš„è®¡æ•°
                        await updateFilterCounts();
                        
                        // æ›´æ–°URLï¼Œä½†ä¸åˆ·æ–°é¡µé¢
                        const newUrl = new URL(window.location.href);
                        
                        // æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„æœç´¢å‚æ•°
                        Array.from(newUrl.searchParams.keys()).forEach(key => {
                            if (key !== 'lang') {  // ä¿ç•™è¯­è¨€å‚æ•°
                                newUrl.searchParams.delete(key);
                            }
                        });
                        
                        // æ·»åŠ åŸºæœ¬å‚æ•°
                        if (processedQuery) newUrl.searchParams.set('q', processedQuery);
                        if (currentMode) newUrl.searchParams.set('mode', currentMode);
                        if (sort) newUrl.searchParams.set('sort', sort);
                        
                        // æ·»åŠ ç­›é€‰å‚æ•°ï¼Œä½¿ç”¨ANDé€»è¾‘
                        Object.entries(filters).forEach(([key, value]) => {
                            if (value) {
                                if (Array.isArray(value)) {
                                    // ä½¿ç”¨Setå»é‡ï¼Œå¹¶å°†æ•°ç»„ä½œä¸ºå•ä¸ªå‚æ•°å€¼æ·»åŠ 
                                    const uniqueValues = [...new Set(value)];
                                    newUrl.searchParams.set(key, uniqueValues.join(','));
                                } else {
                                    newUrl.searchParams.set(key, value);
                                }
                            }
                        });
                        
                        window.history.pushState({}, '', newUrl);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('searchResults').innerHTML = `
                        <div class="error-message">
                            ${lang === 'zh' ? 'æœç´¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•' : 'Search error, please try again later'}
                        </div>
                    `;
                }
            } else {
                // ç®€å•æœç´¢æ¨¡å¼ï¼Œç›´æ¥å‘é€è¯·æ±‚
                try {
                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: query,
                            filters: filters,
                            sort: sort,
                            page: currentPage,
                            page_size: pageSize,
                            mode: currentMode,
                            lang: lang
                        })
                    });

                    if (!response.ok) throw new Error('Search failed');

                    const data = await response.json();
                    if (data.status === 'success') {
                        displaySearchResults(data.data);
                        updatePagination(data.total);
                        document.getElementById('resultCount').textContent = data.total;
                        
                        // æ›´æ–°ç­›é€‰é€‰é¡¹çš„è®¡æ•°
                        await updateFilterCounts();
                        
                        // æ›´æ–°URLï¼Œä½†ä¸åˆ·æ–°é¡µé¢
                        const newUrl = new URL(window.location.href);
                        
                        // æ¸…é™¤æ‰€æœ‰ç°æœ‰çš„æœç´¢å‚æ•°
                        Array.from(newUrl.searchParams.keys()).forEach(key => {
                            if (key !== 'lang') {  // ä¿ç•™è¯­è¨€å‚æ•°
                                newUrl.searchParams.delete(key);
                            }
                        });
                        
                        // æ·»åŠ åŸºæœ¬å‚æ•°
                        if (query) newUrl.searchParams.set('q', query);
                        if (currentMode) newUrl.searchParams.set('mode', currentMode);
                        if (sort) newUrl.searchParams.set('sort', sort);
                        
                        // æ·»åŠ ç­›é€‰å‚æ•°ï¼Œä½¿ç”¨ANDé€»è¾‘
                        Object.entries(filters).forEach(([key, value]) => {
                            if (value) {
                                if (Array.isArray(value)) {
                                    // ä½¿ç”¨Setå»é‡ï¼Œå¹¶å°†æ•°ç»„ä½œä¸ºå•ä¸ªå‚æ•°å€¼æ·»åŠ 
                                    const uniqueValues = [...new Set(value)];
                                    newUrl.searchParams.set(key, uniqueValues.join(','));
                                } else {
                                    newUrl.searchParams.set(key, value);
                                }
                            }
                        });
                        
                        window.history.pushState({}, '', newUrl);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    document.getElementById('searchResults').innerHTML = `
                        <div class="error-message">
                            ${lang === 'zh' ? 'æœç´¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•' : 'Search error, please try again later'}
                        </div>
                    `;
                }
            }
        }

        // é‡ç½®æ‰€æœ‰"æ˜¾ç¤ºæ›´å¤š/æ›´å°‘"æŒ‰é’®çš„çŠ¶æ€
        function resetShowMoreButtons() {
            // é‡ç½®æ¸¸æˆç±»å‹
            const moreCategories = document.querySelector('#gameTypes .more-categories');
            const showMoreCategoriesBtn = document.querySelector('#gameTypes .show-more-btn');
            if (moreCategories && showMoreCategoriesBtn) {
                moreCategories.style.display = 'none';
                showMoreCategoriesBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å¤š' : 'Show More';
            }
            
            // é‡ç½®æ¸¸æˆæ ‡ç­¾
            const moreTags = document.querySelector('#gameTags .more-tags');
            const showMoreTagsBtn = document.querySelector('#gameTags .show-more-btn');
            if (moreTags && showMoreTagsBtn) {
                moreTags.style.display = 'none';
                showMoreTagsBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å¤š' : 'Show More';
            }
        }

        // é‡ç½®æ¸¸æˆç±»å‹ç­›é€‰
        function resetTypeFilter() {
            document.querySelectorAll('#gameTypes input[type="checkbox"]').forEach(cb => cb.checked = false);
            performSearch();
        }

        // é‡ç½®æ¸¸æˆæ ‡ç­¾ç­›é€‰
        function resetTagFilter() {
            document.querySelectorAll('#gameTags input[type="checkbox"]').forEach(cb => cb.checked = false);
            performSearch();
        }

        // é‡ç½®é¢å¤–ç­›é€‰
        function resetAdditionalFilters() {
            // é‡ç½®å‘å¸ƒå¹´ä»½
            document.getElementById('releaseYearFilter').value = '';
            
            // é‡ç½®å¹³å°é€‰æ‹©
            document.querySelectorAll('input[name="platform"]').forEach(cb => cb.checked = false);
            
            // é‡ç½®å¹´é¾„è¯„çº§
            document.querySelectorAll('input[name="ageRating"]').forEach(cb => cb.checked = false);
            
            performSearch();
        }

        // åˆ‡æ¢æ˜¾ç¤ºæ›´å¤šåˆ†ç±»
        function toggleMoreCategories() {
            const moreCategories = document.querySelector('#gameTypes .more-categories');
            const showMoreBtn = document.querySelector('#gameTypes .show-more-btn');
            if (moreCategories && showMoreBtn) {
                if (moreCategories.style.display === 'none') {
                    moreCategories.style.display = 'block';
                    showMoreBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å°‘' : 'Show Less';
                } else {
                    moreCategories.style.display = 'none';
                    showMoreBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å¤š' : 'Show More';
                }
            }
        }

        // åˆ‡æ¢æ˜¾ç¤ºæ›´å¤šæ ‡ç­¾
        function toggleMoreTags() {
            const moreTags = document.querySelector('#gameTags .more-tags');
            const showMoreBtn = document.querySelector('#gameTags .show-more-btn');
            if (moreTags && showMoreBtn) {
                if (moreTags.style.display === 'none') {
                    moreTags.style.display = 'block';
                    showMoreBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å°‘' : 'Show Less';
                } else {
                    moreTags.style.display = 'none';
                    showMoreBtn.textContent = lang === 'zh' ? 'æ˜¾ç¤ºæ›´å¤š' : 'Show More';
                }
            }
        }

        // æŒ‰ç±»åˆ«æœç´¢
        function searchByCategory(category) {
            const checkbox = document.querySelector(`#gameTypes input[value="${category}"]`);
            if (checkbox) {
                // ç›´æ¥åˆ‡æ¢checkboxçš„çŠ¶æ€
                checkbox.checked = !checkbox.checked;
                // è§¦å‘changeäº‹ä»¶ä»¥æ‰§è¡Œæœç´¢
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // æŒ‰ç±»å‹æœç´¢
        function searchByGenre(genre) {
            const checkbox = document.querySelector(`#gameTags input[value="${genre}"]`);
            if (checkbox) {
                // ç›´æ¥åˆ‡æ¢checkboxçš„çŠ¶æ€
                checkbox.checked = !checkbox.checked;
                // è§¦å‘changeäº‹ä»¶ä»¥æ‰§è¡Œæœç´¢
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // æ›´æ–°ç­›é€‰é€‰é¡¹çš„è®¡æ•°
        async function updateFilterCounts() {
            const query = document.getElementById('searchInput').value.trim();
            const filters = getFilters();
            
            try {
                const response = await fetch('/api/search_stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        filters: filters
                    })
                });

                if (!response.ok) throw new Error('Failed to fetch search stats');

                const data = await response.json();
                if (data.status === 'success') {
                    // æ›´æ–°æ¸¸æˆç±»å‹è®¡æ•°
                    const gameTypesContainer = document.querySelector('#gameTypes .visible-categories');
                    const moreCategoriesContainer = document.querySelector('#gameTypes .more-categories');
                    const types = data.gameTypes;
                    
                    // è·å–å½“å‰é€‰ä¸­çš„ç±»å‹ï¼ˆåŒ…æ‹¬é«˜çº§æ£€ç´¢ä¸­é€‰æ‹©çš„ç±»å‹ï¼‰
                    const selectedTypes = new Set([
                        ...(selectedFilters.types || []),
                        ...Array.from(document.querySelectorAll('#gameTypes input[type="checkbox"]:checked'))
                            .map(cb => cb.value)
                    ]);
                    
                    // æ›´æ–°å¯è§ç±»å‹ï¼ˆåªæ˜¾ç¤ºå‰5ä¸ªï¼‰
                    gameTypesContainer.innerHTML = types.slice(0, 5).map(type => `
                        <label class="filter-option">
                            <input type="checkbox" value="${type.id}" 
                                   ${selectedTypes.has(type.id) ? 'checked' : ''}
                                   onchange="performSearch()">
                            <span>${type.name}</span>
                        </label>
                    `).join('');
                    
                    // æ›´æ–°æ›´å¤šç±»å‹ï¼ˆç¬¬6ä¸ªåŠä»¥åï¼‰
                    if (types.length > 5) {
                        moreCategoriesContainer.innerHTML = types.slice(5).map(type => `
                            <label class="filter-option">
                                <input type="checkbox" value="${type.id}"
                                       ${selectedTypes.has(type.id) ? 'checked' : ''}
                                       onchange="performSearch()">
                                <span>${type.name}</span>
                            </label>
                        `).join('');
                        document.querySelector('#gameTypes .show-more-btn').style.display = 'block';
                    } else {
                        document.querySelector('#gameTypes .show-more-btn').style.display = 'none';
                    }

                    // æ›´æ–°æ¸¸æˆæ ‡ç­¾è®¡æ•°
                    const visibleTagsContainer = document.querySelector('#gameTags .visible-tags');
                    const moreTagsContainer = document.querySelector('#gameTags .more-tags');
                    const tags = data.tags;
                    
                    // è·å–å½“å‰é€‰ä¸­çš„æ ‡ç­¾ï¼ˆåŒ…æ‹¬é«˜çº§æ£€ç´¢ä¸­é€‰æ‹©çš„æ ‡ç­¾ï¼‰
                    const selectedTags = new Set([
                        ...(selectedFilters.tags || []),
                        ...Array.from(document.querySelectorAll('#gameTags input[type="checkbox"]:checked'))
                            .map(cb => cb.value)
                    ]);
                    
                    // æ›´æ–°å¯è§æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºå‰5ä¸ªï¼‰
                    visibleTagsContainer.innerHTML = tags.slice(0, 5).map(tag => `
                        <label class="filter-option">
                            <input type="checkbox" value="${tag.id}"
                                   ${selectedTags.has(tag.id) ? 'checked' : ''}
                                   onchange="performSearch()">
                            <span>${tag.name}</span>
                        </label>
                    `).join('');
                    
                    // æ›´æ–°æ›´å¤šæ ‡ç­¾ï¼ˆç¬¬6ä¸ªåŠä»¥åï¼‰
                    if (tags.length > 5) {
                        moreTagsContainer.innerHTML = tags.slice(5).map(tag => `
                            <label class="filter-option">
                                <input type="checkbox" value="${tag.id}"
                                       ${selectedTags.has(tag.id) ? 'checked' : ''}
                                       onchange="performSearch()">
                                <span>${tag.name}</span>
                            </label>
                        `).join('');
                        document.querySelector('#gameTags .show-more-btn').style.display = 'block';
                    } else {
                        document.querySelector('#gameTags .show-more-btn').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating filter counts:', error);
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(games) {
            if (!games || games.length === 0) {
                searchResults.innerHTML = `<div class="no-results">${
                    lang === 'zh' ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¸¸æˆ' : 'No games found'
                }</div>`;
                return;
            }

            const gameCards = games.map(game => {
                const gameCard = document.createElement('a');
                gameCard.href = `/game/${game.æ¸¸æˆåº”ç”¨ID}?lang=${lang}`;
                gameCard.className = 'game-card';
                
                const gameImage = document.createElement('img');
                gameImage.src = game.header_image || '/static/images/placeholder.jpg';
                gameImage.alt = game.åç§°;
                gameImage.onerror = function() { this.src = '/static/images/placeholder.jpg'; };
                
                const gameInfo = document.createElement('div');
                gameInfo.className = 'game-info';
                
                // æ¸¸æˆæ ‡é¢˜
                const title = document.createElement('h3');
                title.textContent = lang === 'en' && game.Name ? game.Name : game.åç§°;
                
                // æ¸¸æˆå…ƒæ•°æ®
                const gameMeta = document.createElement('div');
                gameMeta.className = 'game-meta';
                gameMeta.innerHTML = `
                    <div class="game-date">${formatDate(game.å‘å¸ƒæ—¥æœŸ)}</div>
                    <div class="game-price">${formatPrice(game.ä»·æ ¼)}</div>
                `;
                
                // æ¸¸æˆç»Ÿè®¡
                const gameStats = document.createElement('div');
                gameStats.className = 'game-stats';
                gameStats.innerHTML = `
                    <span class="rating" title="${lang === 'zh' ? 'è¯„åˆ†' : 'Rating'}">
                        ${formatRating(game.å¥½è¯„ç‡)}
                        ${game.è¯„è®ºæ€»æ•° ? 
                          `(${formatNumber(game.è¯„è®ºæ€»æ•°)} ${lang === 'zh' ? 'æ¡è¯„ä»·' : 'reviews'})` : 
                          ''}
                    </span>
                    ${game.æœ€é«˜åŒæ—¶åœ¨çº¿äººæ•° ? 
                      `<span class="peak-ccu" title="${lang === 'zh' ? 'æœ€é«˜åŒæ—¶åœ¨çº¿' : 'Peak CCU'}">
                        ğŸ‘¥ ${formatNumber(game.æœ€é«˜åŒæ—¶åœ¨çº¿äººæ•°)}
                       </span>` : 
                      ''}
                `;
                
                // æ¸¸æˆæ ‡ç­¾
                const gameTags = document.createElement('div');
                gameTags.className = 'game-tags';
                
                // æ·»åŠ ç±»åˆ«æ ‡ç­¾
                if (game.æ¸¸æˆç±»åˆ« && game.æ¸¸æˆç±»åˆ«.length > 0) {
                    game.æ¸¸æˆç±»åˆ«.slice(0, 3).forEach(category => {
                        const categoryTag = document.createElement('span');
                        categoryTag.className = 'category-tag';
                        categoryTag.textContent = category;
                        categoryTag.onclick = (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            searchByCategory(category);
                        };
                        gameTags.appendChild(categoryTag);
                    });
                }
                
                // æ·»åŠ ç©æ³•ç±»å‹æ ‡ç­¾
                if (game.ç©æ³•ç±»å‹ && game.ç©æ³•ç±»å‹.length > 0) {
                    game.ç©æ³•ç±»å‹.slice(0, 3).forEach(genre => {
                        const genreTag = document.createElement('span');
                        genreTag.className = 'genre-tag';
                        genreTag.textContent = genre;
                        genreTag.onclick = (event) => {
                            event.preventDefault();
                            event.stopPropagation();
                            searchByGenre(genre);
                        };
                        gameTags.appendChild(genreTag);
                    });
                }
                
                // å¹³å°å›¾æ ‡
                const gamePlatforms = document.createElement('div');
                gamePlatforms.className = 'game-platforms';
                gamePlatforms.innerHTML = `
                    ${game.æ”¯æŒWindows ? '<span title="Windows">ğŸªŸ</span>' : ''}
                    ${game.æ”¯æŒMac ? '<span title="Mac">ğŸ</span>' : ''}
                    ${game.æ”¯æŒLinux ? '<span title="Linux">ğŸ§</span>' : ''}
                `;
                
                // ç»„è£…æ‰€æœ‰å…ƒç´ 
                gameInfo.appendChild(title);
                gameInfo.appendChild(gameMeta);
                gameInfo.appendChild(gameStats);
                gameInfo.appendChild(gameTags);
                gameInfo.appendChild(gamePlatforms);
                
                gameCard.appendChild(gameImage);
                gameCard.appendChild(gameInfo);
                
                return gameCard;
            });
            
            // æ¸…ç©ºå¹¶æ·»åŠ æ–°çš„æœç´¢ç»“æœ
            searchResults.innerHTML = '';
            gameCards.forEach(card => searchResults.appendChild(card));
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '<div class="pagination-controls">';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (currentPage > 1) {
                html += `<button onclick="changePage(${currentPage - 1})" class="page-btn">
                    ${lang === 'zh' ? 'ä¸Šä¸€é¡µ' : 'Previous'}
                </button>`;
            }

            // é¡µç æŒ‰é’®
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                html += `
                    <button onclick="changePage(${i})" 
                            class="page-btn ${i === currentPage ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (currentPage < totalPages) {
                html += `<button onclick="changePage(${currentPage + 1})" class="page-btn">
                    ${lang === 'zh' ? 'ä¸‹ä¸€é¡µ' : 'Next'}
                </button>`;
            }

            html += '</div>';
            pagination.innerHTML = html;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            currentPage = page;
            performSearch();
            window.scrollTo(0, 0);
        }

        // æ˜¾ç¤ºæ¸¸æˆè¯¦æƒ…
        async function showGameDetail(appId) {
            try {
                const response = await fetch(`/api/game/${appId}?lang=${lang}`);
                if (!response.ok) throw new Error('Failed to fetch game details');
                
                const data = await response.json();
                if (data.status === 'success') {
                    const modal = document.createElement('div');
                    modal.className = 'game-detail-modal';
                    modal.innerHTML = data.html;
                    document.body.appendChild(modal);
                    document.body.style.overflow = 'hidden';

                    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                            document.body.style.overflow = '';
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching game details:', error);
            }
        }

        // æ ¼å¼åŒ–å‡½æ•°
        function formatPrice(price) {
            if (price === 0) return lang === 'zh' ? 'å…è´¹' : 'Free';
            return lang === 'zh' ? `Â¥${price.toFixed(2)}` : `$${price.toFixed(2)}`;
        }

        function formatRating(ratio) {
            if (!ratio && ratio !== 0) return lang === 'zh' ? 'æš‚æ— è¯„åˆ†' : 'No rating';
            const percentage = (ratio * 100).toFixed(1);
            return `${percentage}% ${lang === 'zh' ? 'å¥½è¯„' : 'Positive'}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString(lang === 'zh' ? 'zh-CN' : 'en-US');
        }

        function formatNumber(num) {
            return new Intl.NumberFormat(lang === 'zh' ? 'zh-CN' : 'en-US').format(num);
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // æ›´æ–°é¢å¤–ç­›é€‰çš„æ”¶èµ·/å±•å¼€åŠŸèƒ½
        function toggleAdditionalFilters() {
            const filters = document.getElementById('additionalFilters');
            const toggleBtn = document.querySelector('.toggle-btn');
            const isCollapsed = filters.classList.contains('collapsed');
            
            if (isCollapsed) {
                filters.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                toggleBtn.querySelector('.toggle-icon').textContent = 'â–¼';
            } else {
                filters.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleBtn.querySelector('.toggle-icon').textContent = 'â–¶';
            }
            
            // ä¿å­˜çŠ¶æ€åˆ° localStorage
            localStorage.setItem('additionalFiltersCollapsed', !isCollapsed);
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é¢å¤–ç­›é€‰çš„çŠ¶æ€ï¼Œé»˜è®¤æ”¶èµ·
        document.addEventListener('DOMContentLoaded', function() {
            const filtersCollapsed = localStorage.getItem('additionalFiltersCollapsed') !== 'false'; // é»˜è®¤ä¸ºtrueï¼ˆæ”¶èµ·ï¼‰
            if (filtersCollapsed) {
                const filters = document.getElementById('additionalFilters');
                const toggleBtn = document.querySelector('.toggle-btn');
                filters.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                toggleBtn.querySelector('.toggle-icon').textContent = 'â–¶';
            }
        });
    </script>
</body>
</html>
